export MALLOC_CHECK_=2
export SC_LOG_DIR=/tmp
export SC_LOG_LEVEL=5
export MDIRD_PORT=21654
export SC_FILED_PORT=21436
export MDIRD_HOST=scambio.happyleptic.org
export SMTPD_PORT=1025
#export SC_RUNASUSER=scambio
#export SC_RUNASGROUP=scambio

function auth_user {
	dir=$1
	name=$2
	cat > $dir/$name <<EOF
key: 1234567890DEADBEAF
method: 3des

EOF
}

function auth_users {
	mkdir -p $MDIR_USERS_DIR
	auth_user $MDIR_USERS_DIR Alice
	auth_user $MDIR_USERS_DIR Bob
}

function run_server {
	export MDIR_ROOT_DIR=/tmp/mdsyncd
	export MDIR_USERS_DIR=$MDIR_ROOT_DIR/users
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_MAX_JNL_SIZE=30
	rm -f /tmp/mdsyncd.log
	rm -rf $MDIR_ROOT_DIR
	mkdir -p $MDIR_ROOT_DIR/root
	auth_users
	build/mdsyncd/sc_mdsyncd
}

function run_filed {
	export SC_FILES_DIR=/tmp/filed/files
	rm -f /tmp/filed.log
	mkdir -p $SC_FILES_DIR
	build/filed/sc_filed
}

function send_content {
	nc $MDIRD_HOST $MDIRD_PORT <<EOF
1 auth Alice
2 put /
sc-type: dir
sc-name: mailboxes

3 put /
sc-type: dir
sc-name: calendars

4 put mailboxes
sc-type: dir
sc-name: rixed@happyleptic.org

5 put calendars
sc-type: dir
sc-name: rixed

6 put calendars
sc-type: dir
sc-name: project-X

7 put calendars/rixed
sc-start: 2008 10 21 12 00
sc-stop:  2008 10 21 13 00
sc-descr: lunch time

8 put calendars/rixed
sc-start: 2008 10 21 15 00
sc-stop:  2008 10 21 15 30
sc-descr: meeting prod

9 put calendars/rixed
sc-start: 2008 10 21 15 30
sc-stop:  2008 10 21 16 00
sc-descr: meeting support

10 put calendars/rixed
sc-start: 2008 10 25 12 00
sc-stop:  2008 10 26 12 00
sc-descr: PACS Ramine et Sandron

999 quit
EOF
}

function run_client {
	export MDIR_ROOT_DIR=/tmp/mdsyncc
	export MDIR_USERS_DIR=$MDIR_ROOT_DIR/users
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_MAX_JNL_SIZE=10
	rm -f /tmp/mdsyncc.log
	rm -rf $MDIR_ROOT_DIR
	mkdir -p $MDIR_ROOT_DIR/root
	auth_users
	build/mdsyncc/sc_mdsyncc
}

function run_smtpd {
	export MDIR_ROOT_DIR=/tmp/mdsyncc
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_FILES_DIR=$MDIR_ROOT_DIR/smtpd/files
	mkdir -p $MDIR_FILES_DIR
	rm -f /tmp/smtpd.log
	build/smtpd/sc_smtpd
}

function run_meremail {
	export MDIR_ROOT_DIR=/tmp/mdsyncc
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_FILES_DIR=$MDIR_ROOT_DIR/client/files
	mkdir -p $MDIR_FILES_DIR
	rm -f /tmp/meremail.log
	build/meremail/meremail
}

function run_merecal {
	export MDIR_ROOT_DIR=/tmp/mdsyncc
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_FILES_DIR=$MDIR_ROOT_DIR/client/files
	mkdir -p $MDIR_FILES_DIR
	rm -f /tmp/merecal.log
	build/merecal/merecal
}

function add_client_msg {
	mkdir /tmp/mdsyncc/root/.tmp
	cat > /tmp/mdsyncc/root/.tmp/+test1 <<EOF
test: 1

EOF
}

function send_email {
	nc scambio.happyleptic.org $SMTPD_PORT < smtpd/check/multipart
}

ulimit -c unlimited
