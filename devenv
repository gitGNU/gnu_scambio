export MALLOC_CHECK_=2
export MDIRD_LOG_DIR=/tmp
export MDIRD_LOG_LEVEL=5
export MDIRD_PORT=21435
export MDIRD_HOST=localhost
export MERELIB_LOG_DIR=/tmp
export MERELIB_LOG_LEVEL=5
export SMTPD_PORT=1025

function auth_user {
	dir=$1
	name=$2
	cat > $dir/$name <<EOF
key: 1234567890DEADBEAF
method: 3des

EOF
}

function auth_users {
	mkdir -p $MDIR_USERS_DIR
	auth_user $MDIR_USERS_DIR Alice
	auth_user $MDIR_USERS_DIR Bob
}

function run_server {
	export MDIR_ROOT_DIR=/tmp/mdird
	export MDIR_USERS_DIR=$MDIR_ROOT_DIR/users
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_MAX_JNL_SIZE=30
	rm -f /tmp/mdird.log
	rm -rf $MDIR_ROOT_DIR
	mkdir -p $MDIR_ROOT_DIR/root
	auth_users
	build/mdird/mdird
}

function send_content {
	nc $MDIRD_HOST $MDIRD_PORT <<EOF
0 auth Alice
1 put /
sc-type: dir
sc-name: mailboxes

2 put /
sc-type: dir
sc-name: calendars

3 put mailboxes
sc-type: dir
sc-name: rixed@happyleptic.org

4 put calendars
sc-type: dir
sc-name: rixed

5 put calendars
sc-type: dir
sc-name: project-X

6 put calendars/rixed
sc-start: 2008 10 21 12 00
sc-stop:  2008 10 21 13 00
sc-descr: lunch time

7 put calendars/rixed
sc-start: 2008 10 21 15 00
sc-stop:  2008 10 21 15 30
sc-descr: meeting prod

8 put calendars/rixed
sc-start: 2008 10 21 15 30
sc-stop:  2008 10 21 16 00
sc-descr: meeting support

9 put calendars/rixed
sc-start: 2008 10 25 12 00
sc-stop:  2008 10 26 12 00
sc-descr: PACS Ramine et Sandron

999 quit
EOF
}

function run_client {
	export MDIRC_LOG_DIR=/tmp
	export MDIRC_LOG_LEVEL=5
	export MDIR_ROOT_DIR=/tmp/mdirc
	export MDIR_USERS_DIR=$MDIR_ROOT_DIR/users
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	export MDIR_MAX_JNL_SIZE=10
	rm -f /tmp/mdirc.log
	rm -rf $MDIR_ROOT_DIR
	mkdir -p $MDIR_ROOT_DIR/root
	auth_users
	build/mdirc/mdirc
}

function run_smtpd {
	export SMTPD_LOG_DIR=/tmp
	export SMTPD_LOG_LEVEL=5
	export MDIR_ROOT_DIR=/tmp/mdirc
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	rm -f /tmp/smtpd.log
	build/smtpd/smtpd
}

function run_meremail {
	export MDIR_ROOT_DIR=/tmp/mdirc
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	rm -f /tmp/meremail.log
	build/meremail/meremail
}

function run_merecal {
	export MDIR_ROOT_DIR=/tmp/mdirc
	export MDIR_DIRSEQ=$MDIR_ROOT_DIR/.dirid.seq
	rm -f /tmp/merecal.log
	build/merecal/merecal
}

function add_client_msg {
	mkdir /tmp/mdirc/root/.tmp
	cat > /tmp/mdirc/root/.tmp/+test1 <<EOF
test: 1

EOF
}

function send_email {
	nc localhost $SMTPD_PORT < smtpd/check/multipart
}

ulimit -c unlimited
